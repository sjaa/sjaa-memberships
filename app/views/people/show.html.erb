<div class="container-fluid">
  <!-- Hero Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <h1 class="mb-3">
            <%= @person.first_name %> <%= @person.last_name %>
          </h1>
          <% unless @person.latest_membership&.is_active? %>
            <div class="alert alert-warning mb-3 mb-0" role="alert">
              <strong>Membership Inactive:</strong>
              <%= link_to "Renew your membership", membership_renewal_path(id: @person.id), class: 'alert-link' %>
              to continue receiving benefits.
            </div>
          <% end %>
          <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
            <%= link_to "Edit Profile", edit_person_path(@person), class: 'btn btn-primary' %>
            <%= render partial: 'renew_button' %>
          </div>
          <% if @user.is_a?(Admin) %>
            <div class="btn-group" role="group">
              <%= link_to "Welcome Email", welcome_email_path(@person), class: 'btn btn-sm btn-outline-secondary' %>
              <%= link_to "Renewal Reminder", reminder_email_path(@person), class: 'btn btn-sm btn-outline-secondary' %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  <!-- Profile Information Grid -->
  <div class="row g-4">
    <!-- Personal Information -->
    <div class="col-lg-3">
      <div class="card h-100">
        <div class="card-header bg-body-secondary">
          <h5 class="mb-0">Profile Picture</h5>
        </div>
        <div class="card-body">
          <% if @person.profile_picture.attached? %>
            <div class="text-center mb-3">
              <%= image_tag @person.profile_picture.variant(:display),
                  class: 'rounded img-thumbnail',
                  alt: "#{@person.first_name} #{@person.last_name}" %>
            </div>
          <% else %>
            <div class="rounded bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 150px; height: 150px; margin: 0 auto;">
              <i class="bi bi-person-circle" style="font-size: 4rem;"></i>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header bg-body-secondary">
          <h5 class="mb-0">Personal Information</h5>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <% if @person.volunteer || @person.mentor %>
              <dt class="col-sm-4">Volunteer Status</dt>
              <dd class="col-sm-8">
                <% if @person.volunteer %>
                  <span class="badge bg-primary me-1">Volunteer</span>
                <% end %>
                <% if @person.mentor %>
                  <span class="badge bg-success">Mentor</span>
                <% end %>
              </dd>
            <% end %>
            <% if @person.interests.any? %>
              <dt class="col-sm-4">Interests</dt>
              <dd class="col-sm-8">
                <% @person.interests.each do |interest| %>
                  <span class="badge bg-light text-dark me-1 mb-1"><%= interest.name.titleize %></span>
                <% end %>
              </dd>
            <% end %>
            <% if @person.notes.present? %>
              <dt class="col-sm-4">Notes</dt>
              <dd class="col-sm-8"><%= simple_format(@person.notes) %></dd>
            <% end %>
            <% if @person.referral.present? %>
              <dt class="col-sm-4">Referral</dt>
              <dd class="col-sm-8"><%= @person.referral.name %></dd>
            <% end %>
            <% if @person.astrobin&.username&.present? %>
              <dt class="col-sm-4">Astrobin</dt>
              <dd class="col-sm-8">
                <%= link_to @person.astrobin.username, "https://www.astrobin.com/users/#{@person.astrobin.username}", target: :_blank, class: 'text-decoration-none' %>
                <% if @person.astrobin.latest_image %>
                  <small class="text-muted">(Image ID: <%= @person.astrobin.latest_image %>)</small>
                <% end %>
              </dd>
            <% end %>
            <% if @user.is_a?(Admin) && @person.discord_id.present? %>
              <dt class="col-sm-4">Discord ID</dt>
              <dd class="col-sm-8"><code><%= @person.discord_id %></code></dd>
            <% end %>
            <% if @person.groups.any? %>
              <dt class="col-sm-4">Groups</dt>
              <dd class="col-sm-8">
                <% @person.groups.each do |group| %>
                  <%= link_to group.name, group_path(group), class: 'badge bg-info text-dark me-1 mb-1 text-decoration-none' %>
                <% end %>
              </dd>
            <% end %>
          </dl>
        </div>
      </div>
    </div>
    <!-- Contact Information -->
    <div class="col-lg-3">
      <div class="card h-100">
        <div class="card-header bg-body-secondary">
          <h5 class="mb-0">Contact Information</h5>
        </div>
        <div class="card-body">
          <% if @person.contacts.any? %>
            <% @person.contacts.each_with_index do |contact, i| %>
              <% if i > 0 %><hr><% end %>
              <div class="contact-info">
                <% if contact.primary %>
                  <span class="badge bg-primary mb-2">Primary Contact</span>
                <% elsif @person.contacts.count > 1 %>
                  <h6 class="text-muted">Contact <%= i + 1 %></h6>
                <% end %>
                <% if contact.email.present? %>
                  <div class="mb-2" data-contact-type="email">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope me-2" viewBox="0 0 16 16">
                      <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                    </svg>
                    <%= mail_to contact.email, contact.email, class: 'text-decoration-none' %>
                  </div>
                <% end %>
                <% if contact.phone.present? %>
                  <div class="mb-2" data-contact-type="phone">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-telephone me-2" viewBox="0 0 16 16">
                      <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.568 17.568 0 0 0 4.168 6.608 17.569 17.569 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.678.678 0 0 0-.58-.122l-2.19.547a1.745 1.745 0 0 1-1.657-.459L5.482 8.062a1.745 1.745 0 0 1-.46-1.657l.548-2.19a.678.678 0 0 0-.122-.58L3.654 1.328zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.678.678 0 0 0 .178.643l2.457 2.457a.678.678 0 0 0 .644.178l2.189-.547a1.745 1.745 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.634 18.634 0 0 1-7.01-4.42 18.634 18.634 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877L1.885.511z"/>
                    </svg>
                    <%= link_to contact.phone, "tel:#{contact.phone}", class: 'text-decoration-none' %>
                  </div>
                <% end %>
                <% if contact.address.present? || contact.city.present? || contact.state.present? || contact.zipcode.present? %>
                  <div class="mb-2" data-contact-type="address">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-geo-alt me-2" viewBox="0 0 16 16">
                      <path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A31.493 31.493 0 0 1 8 14.58a31.481 31.481 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94zM8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10z"/>
                      <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                    </svg>
                    <% if contact.address.present? %>
                      <%= contact.address %><br>
                      <span class="ms-4">
                      <% end %>
                      <%= [contact.city&.name, contact.state&.short_name].compact.join(', ') %>
                      <%= contact.zipcode %>
                      <% if contact.address.present? %>
                      </span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">No contact information on file.</p>
          <% end %>
        </div>
      </div>
    </div>
    <!-- Volunteer Skills -->
    <% active_skills = @person.people_skills.select(&:active?).sort_by { |ps| -ps.skill_level.to_i } %>
    <% if @person.volunteer || @person.mentor || active_skills.any? %>
      <div class="col-12">
        <h5 class="mb-3 p-2 bg-body-secondary rounded">Skills</h5>
      </div>
      <% if active_skills.any? %>
        <% active_skills.each do |people_skill| %>
          <div class="col-md-6 col-lg-4">
            <%= render partial: 'shared/skill_card', locals: { people_skill: people_skill } %>
          </div>
        <% end %>
      <% else %>
        <div class="col-12">
          <div class="alert alert-info" role="alert">
            <% if @person.volunteer %>
              Interested in volunteering but no specific skills indicated yet.
            <% elsif @person.mentor %>
              Willing to mentor but no specific skills indicated yet.
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
    <!-- Membership History -->
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-body-secondary d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Membership History</h5>
          <% if @person.first_membership %>
            <small class="text-muted">Member since <%= date_format(@person.first_membership.start) %></small>
          <% end %>
        </div>
        <div class="card-body">
          <% if @person.memberships.any? %>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>Duration</th>
                    <th>Type</th>
                    <th class="text-end">Donation</th>
                    <th class="text-center">Ephemeris</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @person.memberships.reverse.each do |membership| %>
                    <tr class="<%= 'table-success' if membership.is_active? %>">
                      <td>
                        <% if membership.term_months.nil? %>
                          <strong>LIFETIME</strong>
                        <% else %>
                          <%= date_format(membership.start) %> to <%= date_format(membership.end) %>
                          <br>
                          <small class="text-muted"><%= membership.term_months %> months</small>
                        <% end %>
                      </td>
                      <td><%= membership.kind&.name %></td>
                      <td class="text-end"><%= dollar_format(membership.donation_amount) %></td>
                      <td class="text-center"><%= ephemeris_format membership.ephemeris %></td>
                      <td>
                        <% if membership.is_active? %>
                          <span class="badge bg-success">Active</span>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted mb-0">No membership history.</p>
          <% end %>
        </div>
      </div>
    </div>
    <!-- Donations (if any) -->
    <% if @person.donations.count > 0 %>
      <div class="col-12">
        <h5 class="mb-3 p-2 bg-body-secondary rounded">Donations</h5>
      </div>
      <%= render partial: 'donations/index', locals: {donations: @person.donations} %>
    <% end %>
    <!-- Admin Actions -->
    <% if @user.is_a?(Admin) %>
      <div class="col-12">
        <div class="card border-danger">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0">Admin Actions</h5>
          </div>
          <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
              <%= button_to "Delete Person", @person, method: :delete,
                  data: {turbo_confirm: 'Are you TOTALLY sure??'},
                  class: 'btn btn-sm btn-danger' %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
