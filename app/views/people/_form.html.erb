<%= form_with(model: person) do |form| %>
  <div class="row">
    <div class="col-md-6 mt-2">
      <%= form.label :first_name, 'First Name', class: 'form-label' %>
      <%= form.text_field :first_name, class: 'form-control' %>
    </div>
    <div class="col-md-6 mt-2">
      <%= form.label :last_name, 'Last Name', class: 'form-label' %>
      <%= form.text_field :last_name, class: 'form-control' %>
    </div>
    <div class="col-md-12 mt-2">
      <%= form.label :profile_picture, 'Profile Picture', class: 'form-label mb-0' %>
      <br/>
      <small class="form-text text-muted">
        Optional. Upload a profile picture (JPG, PNG, or GIF).
      </small>
      <% if person.profile_picture.attached? %>
        <div class="mt-2 mb-2">
          <%= image_tag person.profile_picture.variant(resize_to_limit: [200, 200]), class: 'img-thumbnail' %>
        </div>
      <% end %>
      <%= form.file_field :profile_picture, class: 'form-control', accept: 'image/*' %>
    </div>
    <div class="col-md-6 mt-2">
      <%= hidden_field_tag 'person[astrobin_attributes][id]', person.astrobin&.id %>
      <%= form.label :astrobin_username, 'Astrobin Username', class: 'form-label mb-0' %>
      <br/>
      <small class="form-text text-muted">
        Optional.  If you use Astrobin, feel free to share your images with us by providing your
        account name.  We will use this to highlight your images to our members.
      </small>
      <%= text_field_tag 'person[astrobin_attributes][username]', person.astrobin&.username, class: 'form-control' %>
    </div>
    <div class="col-md-6 mt-2">
      <%= hidden_field_tag 'person[telescopius_attributes][id]', person.telescopius&.id %>
      <%= form.label :telescopius_username, 'Telescopius Username', class: 'form-label mb-0' %>
      <br/>
      <small class="form-text text-muted">
        Optional.  If you use Telescopius, feel free to share your images with us by providing your
        account name.  We will use this to highlight your images to our members.
      </small>
      <%= text_field_tag 'person[telescopius_attributes][username]', person.telescopius&.username, class: 'form-control' %>
    </div>
    <div class="col-md-6 mt-2">
      <%= form.label :referral_id, class: 'form-label mb-0' %>
      <br/>
      <small class="form-text text-muted">
        Optional.  Please tell us how you heard of us.
      </small>
      <%= form.combobox :referral_id, Referral.all %>
    </div>
    <div class="col-12 mt-2">
      <%= form.label :notes, class: 'form-label mb-0' %>
      <br/>
      <small class="form-text text-muted">
        Optional.  Please tell us about any telescopes or equipment you own, or any other information you would like to share with us.
      </small>
      <%= form.text_area :notes, class: 'form-control' %>
    </div>
    <% if @user.is_a?(Admin) %>
      <div class="col-md-6 mt-2">
        <%= form.label :discord_id, 'Discord ID', class: 'form-label mb-0' %>
        <br/>
        <small class="form-text text-muted">
          Optional.  This is currently only used in Discord, and should usually be set by individuals using the Discord commands.
        </small>
        <%= form.text_field :discord_id, class: 'form-control' %>
      </div>
      <div class="col-md-6 mt-2">
        <%= form.label :astrobin_last_image, 'Latest Astrobin Image ID', class: 'form-label' %>
        <%= number_field_tag 'person[astrobin_attributes][latest_image]', person&.astrobin&.latest_image, class: 'form-control' %>
      </div>
    <% end %>
    <div class="col-md-12 mt-2" data-controller="group-toggle">
      <%= form.label :interests, 'Interests', class: 'form-label mb-0' %>
      <p>
        <small class="form-text text-muted">
          Please tell us what areas of astronomy you are interested in.  This information will help us better
          serve our members, and shape our offerings.
        </small>
      </p>
      <% interest_ids = person.interests.map(&:id) %>
      <% Interest.all.order(:name).each do |interest|%>
        <% is_selected = interest_ids.include?(interest.id) %>
        <%= check_box_tag "person[interests_attributes][][id]", interest.id, is_selected, autocomplete: "off", id: "interest_#{interest.id}", class: 'btn-check', data: { group_toggle_target: 'checkbox' } %>
        <label class="btn <%= is_selected ? 'btn-success' : 'btn-outline-secondary' %> mb-2"
               for="interest_<%=interest.id%>"
               data-group-toggle-target="label"
               data-action="click->group-toggle#toggle"
               style="cursor: pointer; transition: all 0.2s ease;">
          <span data-group-toggle-target="icon">
            <% if is_selected %>
              ✓
            <% else %>
              +
            <% end %>
          </span>
          <%=interest.name.titleize%>
        </label>
      <% end %>
    </div>
  </div>
  <!-- Joinable Groups Section (for all users) -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h2 class="h4 mb-0">Groups</h2>
        </div>
        <div class="card-body" data-controller="group-toggle">
          <p>
            <small class="form-text text-muted">
              Join groups to receive updates and participate in group activities. Click to join or leave a group.
            </small>
          </p>
          <%= hidden_field_tag "person[joinable_group_ids][]", "" %>
          <% group_ids = person.groups.select(&:joinable).map(&:id) %>
          <% Group.where(joinable: true).order(:name).each do |group| %>
            <% is_joined = group_ids.include?(group.id) %>
            <%= check_box_tag "person[joinable_group_ids][]", group.id, is_joined, autocomplete: "off", id: "group_#{group.id}", class: 'btn-check', data: { group_toggle_target: 'checkbox' } %>
            <label class="btn <%= is_joined ? 'btn-success' : 'btn-outline-secondary' %> mb-2"
                   for="group_<%=group.id%>"
                   data-group-toggle-target="label"
                   data-action="click->group-toggle#toggle"
                   style="cursor: pointer; transition: all 0.2s ease;">
              <span data-group-toggle-target="icon">
                <% if is_joined %>
                  ✓
                <% else %>
                  +
                <% end %>
              </span>
              <%= group.name %>
              <% if group.members_only %>
                <span class="badge bg-primary ms-1">Members Only</span>
              <% else %>
                <span class="badge bg-info ms-1">Public</span>
              <% end %>
            </label>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  <% if @user.is_a?(Admin) %>
    <!-- Groups -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h2 class="h4 mb-0">Admin Groups</h2>
          </div>
          <div class="card-body">
            <div data-controller="form">
              <div data-form-target="fields">
                <% person.groups.each_with_index do |group, i| %>
                  <%= render partial: 'group_form', locals: {id: "group_#{group.id}", group: group, i: i, person: person} %>
                <% end %>
                <template data-form-target="template">
                  <%= render partial: 'group_form', locals: {id: "NEWID", group: Group.new } %>
                </template>
              </div>
              <div class="row">
                <div class="col-12 mt-3">
                  <button type="button" data-form-baseid-param="new_group" data-action="form#addField" class="btn btn-outline-secondary">+ Add Group</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Permissions (only for users with "permit" permission) -->
    <% if @user.has_permission?(:permit) %>
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h2 class="h4 mb-0">Permissions</h2>
            </div>
            <div class="card-body">
              <p>
                <small class="form-text text-muted">
                  Assign specific permissions to this member. These control what actions they can perform in the system.
                </small>
              </p>
              <%= render partial: 'layouts/combobox', locals: {field: :permissions, objects: person.permissions, name: :name, value: :id, form_field_id: 'person[permission_attributes]', select_values: Permission.all, allow_new: false} %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
  <!-- Contacts -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card mb-3">
        <div class="card-header">
          <h2 class="h4 mb-0">Contacts</h2>
        </div>
      </div>
      <% if @user.is_a?(Admin) %>
        <div data-controller="form">
          <div data-form-target="fields">
            <% person.contacts.each_with_index do |contact, i| %>
              <%= render partial: 'contact_form', locals: {id: "contact_#{contact.id}", contact: contact, i: i, person: person} %>
            <% end %>
            <template data-form-target="template">
              <%= render partial: 'contact_form', locals: {id: "NEWID", contact: Contact.new, i: nil, person: person} %>
            </template>
          </div>
          <div class="mt-3">
            <button type="button" data-form-baseid-param="new_contact" data-action="form#addField" class="btn btn-outline-secondary">+ Add Contact</button>
          </div>
        </div>
      <% else %>
        <% person.contacts.each_with_index do |contact, i| %>
          <%= render partial: 'contact_form', locals: {id: "contact_#{contact.id}", contact: contact, i: i, person: person} %>
        <% end %>
      <% end %>
    </div>
  </div>
  <!-- Volunteer Skills Section -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h2 class="h4 mb-0">Volunteer Skills</h2>
        </div>
        <div class="card-body">
          <!-- Volunteer/Mentor Checkboxes -->
      <div class="row">
        <div class="col-md-6 mt-2">
          <div class="form-check">
            <%= form.check_box :volunteer, class: 'form-check-input' %>
            <%= form.label :volunteer, class: 'form-check-label' %>
          </div>
          <small class="form-text text-muted">
            Check if you're interested in volunteering with SJAA
          </small>
        </div>
        <div class="col-md-6 mt-2">
          <div class="form-check">
            <%= form.check_box :mentor, class: 'form-check-input' %>
            <%= form.label :mentor, class: 'form-check-label' %>
          </div>
          <small class="form-text text-muted">
            Check if you're interested in mentoring other members
          </small>
        </div>
      </div>
      <div class="mt-4" data-controller="skills">
        <% current_skills = person.people_skills.index_by(&:skill_id) %>
        <% active_skills = current_skills.select { |_, ps| PeopleSkill.skill_levels[ps.skill_level].to_i > 0 } %>
        <!-- Active Skills (always shown) -->
        <div id="active-skills" data-skills-target="activeSkills">
          <% if active_skills.any? %>
            <h5 class="mb-3">Your Skills</h5>
            <p class="mb-3">
              <small class="form-text text-muted">
                Use the slider to indicate your skill level: None, Beginner, Intermediate, or Advanced
              </small>
            </p>
            <% Skill.where(id: active_skills.keys).order(:name).each do |skill| %>
              <%= render partial: 'skill_slider', locals: { skill: skill, people_skill: current_skills[skill.id] } %>
            <% end %>
          <% end %>
        </div>
        <!-- Hidden Skills (shown on click) -->
        <div id="additional-skills" class="mt-3" style="display: none;" data-skills-target="additionalSkills">
          <h5 class="mb-3">Available Skills</h5>
          <p class="mb-3">
            <small class="form-text text-muted">
              Use the slider to indicate your skill level: None, Beginner, Intermediate, or Advanced
            </small>
          </p>
          <% Skill.where.not(id: active_skills.keys).order(:name).each do |skill| %>
            <%= render partial: 'skill_slider', locals: { skill: skill, people_skill: current_skills[skill.id] } %>
          <% end %>
        </div>
        <!-- Toggle Button -->
        <button type="button"
                class="btn btn-outline-secondary mt-3"
                data-action="click->skills#toggleAdditional"
          data-skills-target="toggleButton">
          <span data-skills-target="toggleText">+ Add More Skills</span>
        </button>
      </div>
        </div>
      </div>
    </div>
  </div>
  <% if @user.is_a?(Admin) %>
    <!-- Memberships -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card mb-3">
          <div class="card-header">
            <h2 class="h4 mb-0">Memberships</h2>
          </div>
        </div>
        <div data-controller="form">
          <div data-form-target="fields">
            <% person.memberships.each_with_index do |membership, i| %>
              <%= render partial: 'membership_form', locals: {id: "membership_#{membership.id}", membership: membership, i: i, person: person} %>
            <% end %>
            <template data-form-target="template">
              <%= render partial: 'membership_form', locals: {id: "NEWID", membership: Membership.new, i: nil, person: person} %>
            </template>
          </div>
          <div class="mt-3">
            <button type="button" data-form-baseid-param="new_membership" data-action="form#addField" class="btn btn-outline-secondary">+ Add Membership</button>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  <!-- Submit -->
  <div class="row">
    <div class="col-12 mt-2">
      <hr class="thick"/>
      <%= form.submit 'Save Changes', class: 'btn btn-primary' %>
      <%= link_to "Cancel" , @person, class: 'btn btn-secondary' %>
    </div>
  </div>
<% end %>
