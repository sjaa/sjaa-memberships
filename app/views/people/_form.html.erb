<%= form_with(model: person) do |form| %>
  <div class="row">
    <div class="col-md-6 mt-2">
      <%= form.label :first_name, 'First Name', class: 'form-label' %>
      <%= form.text_field :first_name, class: 'form-control' %>
    </div>
    <div class="col-md-6 mt-2">
      <%= form.label :last_name, 'Last Name', class: 'form-label' %>
      <%= form.text_field :last_name, class: 'form-control' %>
    </div>
    <div class="col-md-6 mt-2">
      <%= form.label :referral_id, class: 'form-label mb-0' %>
      <br/>
      <small class="form-text text-muted">
        Optional.  Please tell us how you heard of us.
      </small>
      <%= form.combobox :referral_id, Referral.all %>
    </div>
    <div class="col-md-6 mt-2">
      <%= hidden_field_tag 'person[astrobin_attributes][id]', person.astrobin&.id %>
      <%= form.label :astrobin_username, 'Astrobin Username', class: 'form-label mb-0' %>
      <br/>
      <small class="form-text text-muted">
        Optional.  If you use Astrobin, feel free to share your images with us by providing your
        account name.  We will use this to highlight your images to our members.
      </small>
      <%= text_field_tag 'person[astrobin_attributes][username]', person.astrobin&.username, class: 'form-control' %>
    </div>
    <div class="col-12 mt-2">
      <%= form.label :notes, class: 'form-label mb-0' %>
      <br/>
      <small class="form-text text-muted">
        Optional.  Please tell us about any telescopes or equipment you own, or any other information you would like to share with us.
      </small>
      <%= form.text_area :notes, class: 'form-control' %>
    </div>
    <% if @user.is_a?(Admin) %>
      <div class="col-md-6 mt-2">
        <%= form.label :discord_id, 'Discord ID', class: 'form-label mb-0' %>
        <br/>
        <small class="form-text text-muted">
          Optional.  This is currently only used in Discord, and should usually be set by individuals using the Discord commands.
        </small>
        <%= form.text_field :discord_id, class: 'form-control' %>
      </div>
      <div class="col-md-6 mt-2">
        <%= form.label :astrobin_last_image, 'Latest Astrobin Image ID', class: 'form-label' %>
        <%= number_field_tag 'person[astrobin_attributes][latest_image]', person&.astrobin&.latest_image, class: 'form-control' %>
      </div>
    <% end %>
    <div class="col-md-12 mt-2">
      <%= form.label :interests, 'Interests', class: 'form-label mb-0' %>
      <p>
        <small class="form-text text-muted">
          Please tell us what areas of astronomy you are interested in.  This information will help us better
          serve our members, and shape our offerings.
        </small>
      </p>
      <% interest_ids = person.interests.map(&:id) %>
      <% Interest.all.each do |interest|%>
        <%= check_box_tag "person[interests_attributes][][id]", interest.id, interest_ids.include?(interest.id), autocomplete: "off", id: "interest_#{interest.id}", class: 'btn-check' %>
        <label class="btn btn-light" for="interest_<%=interest.id%>"><%=interest.name.titleize%></label>
      <% end %>
    </div>
  </div>
  <%# TODO: Enable when groups are controllable via Google %>
  <% if false %>
    <!-- Joinable Roles Section (for all users) -->
    <div class="row mt-4 pb-4 pt-2">
      <div class="col-12">
        <h2 class="p-2 bg-body-secondary">Groups</h2>
        <p>
          <small class="form-text text-muted">
            Join groups to receive updates and participate in group activities.
          </small>
        </p>
        <%= hidden_field_tag "person[joinable_role_ids][]", "" %>
        <% role_ids = person.roles.select(&:joinable).map(&:id) %>
        <% Role.where(joinable: true).each do |role| %>
          <%= check_box_tag "person[joinable_role_ids][]", role.id, role_ids.include?(role.id), autocomplete: "off", id: "role_#{role.id}", class: 'btn-check' %>
          <label class="btn btn-light" for="role_<%=role.id%>"><%=role.name%></label>
        <% end %>
      </div>
    </div>
  <% end %>
  <!--
  <div class="row mt-4 pb-4 pt-2">
    <div class="col-12">
      <div data-controller="form">
        <div data-form-target="fields">
          <h2 class="p-2 bg-body-secondary">Interests</h2>
          <p>
            Please tell us what areas of astronomy you are interested in.  This information will help us better
            serve our members, and shape our offerings.
          </p>
          <% interests = person&.interests&.empty? ? [Interest.new()] : person.interests %>
          <% interests.each_with_index do |interest, i| %>
            <% id = "interest_#{interest.id}"%>
            <div id="<%=id%>" class="row">
              <div class="col-md-6 col-xs-8 mt-2">
                <% options = {value: interest.id} %>
                <% options[:name_when_new] = "person[interests_attributes][][name]" if(@user.is_a?(Admin)) %>
                <%= combobox_tag "person[interests_attributes][][id]",  Interest.all.map{|i| {display: i.name&.titleize, value: i.id}}, **options %>
              </div>
              <div class="col-md-6 col-xs-4 mt-2">
                <button type="button" data-form-id-param="<%=id%>" data-action="form#removeField" class="btn btn-danger">Remove Interest</button>
              </div>
            </div>
          <% end %>
          <template data-form-target="template">
            <div id="NEWID" class="row">
              <div class="col-md-6 col-xs-8 mt-2">
                <% options = {} %>
                <% options[:name_when_new] = "person[interests_attributes][][name]" if(@user.is_a?(Admin)) %>
                <%= combobox_tag "person[interests_attributes][][id]",  Interest.all.map{|i| {display: i.name&.titleize, value: i.id}}, **options %>
              </div>
              <div class="col-md-6 col-xs-4 mt-2">
                <button type="button" data-form-id-param="NEWID" data-action="form#removeField" class="btn btn-danger">Remove</button>
              </div>
            </div>
          </template>
        </div>
        <div class="row">
          <div class="col-12 mt-2">
            <button type="button" data-form-baseid-param="new_interest" data-action="form#addField" class="btn btn-secondary">Add Interest</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  -->
  <% if @user.is_a?(Admin) %>
    <!-- Roles -->
    <div class="row mt-4 pb-4 pt-2">
      <div class="col-12">
        <div data-controller="form">
          <div data-form-target="fields" class="mt-4">
            <h2 class="p-2 bg-body-secondary">Roles</h2>
            <% person.roles.each_with_index do |role, i| %>
              <%= render partial: 'role_form', locals: {id: "role_#{role.id}", role: role, i: i, person: person} %>
            <% end %>
            <template data-form-target="template">
              <%= render partial: 'role_form', locals: {id: "NEWID", role: Role.new } %>
            </template>
          </div>
          <div class="row">
            <div class="col-12 mt-2">
              <button type="button" data-form-baseid-param="new_role" data-action="form#addField" class="btn btn-secondary">Add Role</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Permissions (only for users with "permit" permission) -->
    <% if @user.has_permission?(:permit) %>
      <div class="row mt-4 pb-4 pt-2">
        <div class="col-12">
          <h2 class="p-2 bg-body-secondary">Permissions</h2>
          <p>
            <small class="form-text text-muted">
              Assign specific permissions to this member. These control what actions they can perform in the system.
            </small>
          </p>
          <%= render partial: 'layouts/combobox', locals: {field: :permissions, objects: person.permissions, name: :name, value: :id, form_field_id: 'person[permission_attributes]', select_values: Permission.all, allow_new: false} %>
        </div>
      </div>
    <% end %>
  <% end %>
  <!-- Contacts -->
  <% if @user.is_a?(Admin) %>
    <div class="row mt-4 pb-4 pt-2" data-controller="form">
      <div class="col-12" data-form-target="fields">
        <h2 class="p-2 bg-body-secondary">Contacts</h2>
        <% person.contacts.each_with_index do |contact, i| %>
          <%= render partial: 'contact_form', locals: {id: "contact_#{contact.id}", contact: contact, i: i, person: person} %>
        <% end %>
        <template data-form-target="template">
          <%= render partial: 'contact_form', locals: {id: "NEWID", contact: Contact.new, i: nil, person: person} %>
        </template>
      </div>
      <div class="row">
        <div class="col-12 mt-2">
          <button type="button" data-form-baseid-param="new_contact" data-action="form#addField" class="btn btn-secondary">Add Contact</button>
        </div>
      </div>
    </div>
  <% else %>
    <% person.contacts.each_with_index do |contact, i| %>
      <%= render partial: 'contact_form', locals: {id: "contact_#{contact.id}", contact: contact, i: i, person: person} %>
    <% end %>
  <% end %>
  <!-- Volunteer Skills Section -->
  <div class="row mt-4 pb-4 pt-2">
    <div class="col-12">
      <h2 class="p-2 bg-body-secondary">Volunteer Skills</h2>
      <!-- Volunteer/Mentor Checkboxes -->
      <div class="row">
        <div class="col-md-6 mt-2">
          <div class="form-check">
            <%= form.check_box :volunteer, class: 'form-check-input' %>
            <%= form.label :volunteer, class: 'form-check-label' %>
          </div>
          <small class="form-text text-muted">
            Check if you're interested in volunteering with SJAA
          </small>
        </div>
        <div class="col-md-6 mt-2">
          <div class="form-check">
            <%= form.check_box :mentor, class: 'form-check-input' %>
            <%= form.label :mentor, class: 'form-check-label' %>
          </div>
          <small class="form-text text-muted">
            Check if you're interested in mentoring other members
          </small>
        </div>
      </div>
      <div class="mt-4" data-controller="skills">
        <% current_skills = person.people_skills.index_by(&:skill_id) %>
        <% active_skills = current_skills.select { |_, ps| ps.skill_level > 0 || ps.interest_level > 0 } %>
        <!-- Active Skills (always shown) -->
        <div id="active-skills" data-skills-target="activeSkills">
          <% if active_skills.any? %>
            <h5 class="mb-3">Your Skills</h5>
            <p class="mb-3">
              <small class="form-text text-muted">
                Use the sliders to indicate your skill level (0=none, 10=expert) and interest level (0=not interested, 10=very interested)
              </small>
            </p>
            <% Skill.where(id: active_skills.keys).order(:name).each do |skill| %>
              <%= render partial: 'skill_slider', locals: { skill: skill, people_skill: current_skills[skill.id] } %>
            <% end %>
          <% end %>
        </div>
        <!-- Hidden Skills (shown on click) -->
        <div id="additional-skills" class="mt-3" style="display: none;" data-skills-target="additionalSkills">
          <h5 class="mb-3">Available Skills</h5>
          <p class="mb-3">
            <small class="form-text text-muted">
              Use the sliders to indicate your skill level (0=none, 10=expert) and interest level (0=not interested, 10=very interested)
            </small>
          </p>
          <% Skill.where.not(id: active_skills.keys).order(:name).each do |skill| %>
            <%= render partial: 'skill_slider', locals: { skill: skill, people_skill: current_skills[skill.id] } %>
          <% end %>
        </div>
        <!-- Toggle Button -->
        <button type="button"
                class="btn btn-outline-secondary mt-3"
                data-action="click->skills#toggleAdditional"
          data-skills-target="toggleButton">
          <span data-skills-target="toggleText">+ Add More Skills</span>
        </button>
      </div>
    </div>
  </div>
  <% if @user.is_a?(Admin) %>
    <!-- Memberships -->
    <div class="row mt-4 pb-4 pt-2">
      <div class="col-12">
        <div data-controller="form">
          <div data-form-target="fields" class="mt-4">
            <h2 class="p-2 bg-body-secondary">Memberships</h2>
            <% person.memberships.each_with_index do |membership, i| %>
              <%= render partial: 'membership_form', locals: {id: "membership_#{membership.id}", membership: membership, i: i, person: person} %>
            <% end %>
            <template data-form-target="template">
              <%= render partial: 'membership_form', locals: {id: "NEWID", membership: Membership.new, i: nil, person: person} %>
            </template>
          </div>
          <div class="row">
            <div class="col-12 mt-2">
              <button type="button" data-form-baseid-param="new_membership" data-action="form#addField" class="btn btn-secondary">Add Membership</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  <!-- Submit -->
  <div class="row">
    <div class="col-12 mt-2">
      <hr class="thick"/>
      <%= form.submit 'Save Changes', class: 'btn btn-primary' %>
      <%= link_to "Cancel" , @person, class: 'btn btn-secondary' %>
    </div>
  </div>
<% end %>
