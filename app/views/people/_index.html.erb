<%= turbo_frame_tag 'people' do %>
  <div class="row" data-controller="clipboard column-visibility">
    <div class="col-sm-12 col-md-6 mt-2">
      <table class="table table-hover table-striped table-sm">
        <% @totals&.each do |type, val| %>
          <tr>
            <td><strong><%=type&.to_s&.titleize%></strong></td>
            <td><%=val%><td>
          </tr>
        <% end %>
      </table>
    </div>
    <div class="col-12 mt-2">
      <%= button_tag 'Copy Link', class: 'btn btn-secondary d-inline-block', style: 'min-width: 100px; margin-right: 20px;',
          data: {action: 'clipboard#copy', clipboard_text_param: people_url(@query_params)}  %>
      <%= link_to "Download CSV (SJAA DB)", people_path(@query_params&.merge({format: :csv})), class: 'btn btn-success d-inline-block', style: 'margin-right: 20px;', data: {turbo: false} %>
      <%= link_to "New Person", new_person_path, class: 'btn btn-primary d-inline-block', data: {turbo: false} %>
    </div>
    <div class="col-12 mt-2">
      <%= pagy_bootstrap_nav(@pagy, anchor_string: 'data-turbo-frame="_self"').html_safe %>
    </div>
    <div class="col-12 clearfix mb-2" data-clipboard-target="status">
    </div>
    <div class="col-12 mb-3">
      <div class="accordion" id="columnVisibilityAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseColumnVisibility" aria-expanded="false" aria-controls="collapseColumnVisibility">
              <strong>Show/Hide Columns</strong>
            </button>
          </h2>
          <div id="collapseColumnVisibility" class="accordion-collapse collapse" data-bs-parent="#columnVisibilityAccordion">
            <div class="accordion-body">
              <div class="row">
                <div class="col-12">
                  <p class="mb-2"><small class="text-muted">Toggle columns to customize your view. Your preferences will be saved.</small></p>
                </div>
                <div class="col-md-3 col-sm-6">
                  <div class="form-check">
                    <%= check_box_tag 'column_phone', 'phone', true, class: 'form-check-input', data: { column_visibility_target: 'checkbox', column: 'phone', action: 'change->column-visibility#toggle' } %>
                    <%= label_tag 'column_phone', 'Phone', class: 'form-check-label' %>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6">
                  <div class="form-check">
                    <%= check_box_tag 'column_city', 'city', true, class: 'form-check-input', data: { column_visibility_target: 'checkbox', column: 'city', action: 'change->column-visibility#toggle' } %>
                    <%= label_tag 'column_city', 'City', class: 'form-check-label' %>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6">
                  <div class="form-check">
                    <%= check_box_tag 'column_state', 'state', true, class: 'form-check-input', data: { column_visibility_target: 'checkbox', column: 'state', action: 'change->column-visibility#toggle' } %>
                    <%= label_tag 'column_state', 'State', class: 'form-check-label' %>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6">
                  <div class="form-check">
                    <%= check_box_tag 'column_ephemeris', 'ephemeris', true, class: 'form-check-input', data: { column_visibility_target: 'checkbox', column: 'ephemeris', action: 'change->column-visibility#toggle' } %>
                    <%= label_tag 'column_ephemeris', 'Ephemeris', class: 'form-check-label' %>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6">
                  <div class="form-check">
                    <%= check_box_tag 'column_interests', 'interests', true, class: 'form-check-input', data: { column_visibility_target: 'checkbox', column: 'interests', action: 'change->column-visibility#toggle' } %>
                    <%= label_tag 'column_interests', 'Interests', class: 'form-check-label' %>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6">
                  <div class="form-check">
                    <%= check_box_tag 'column_roles', 'roles', true, class: 'form-check-input', data: { column_visibility_target: 'checkbox', column: 'roles', action: 'change->column-visibility#toggle' } %>
                    <%= label_tag 'column_roles', 'Roles', class: 'form-check-label' %>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6">
                  <div class="form-check">
                    <%= check_box_tag 'column_skills', 'skills', true, class: 'form-check-input', data: { column_visibility_target: 'checkbox', column: 'skills', action: 'change->column-visibility#toggle' } %>
                    <%= label_tag 'column_skills', 'Skills', class: 'form-check-label' %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-hover table-striped table-sm" data-column-visibility-target="table">
      <tr>
        <th>Status</th>
        <th>Name</th>
        <th>Email</th>
        <th data-column="phone">Phone</th>
        <th data-column="city">City</th>
        <th data-column="state">State</th>
        <th data-column="ephemeris">Ephemeris</th>
        <th data-column="interests">Interests</th>
        <th data-column="roles">Roles</th>
        <th data-column="skills">Skills</th>
        <!--<th>Donations</th>-->
      </tr>
      <tbody class="table-group-divider">
        <% @people.each do |person| %>
          <% active_membership = person.membership_map(@active_memberships, true)&.last %>
          <% active = active_membership ? 'ACTIVE' : 'INACTIVE' %>
          <tr>
            <td class="<%=active.downcase%>"><%=active%></td>
            <td><%=link_to "#{person.first_name} #{person.last_name}", person_path(person.id), data: {turbo: false} %></td>
            <td><%=person.contacts.map(&:email).join('<br/>').html_safe%></td>
            <td data-column="phone"><%=person.contacts.map(&:phone).join('<br/>').html_safe%></td>
            <td data-column="city"><%=person.contacts.map{|con| con.city&.name}.join('<br/>').html_safe%></td>
            <td data-column="state"><%=person.contacts.map{|con| con.state&.short_name}.join('<br/>').html_safe%></td>
            <td data-column="ephemeris"><%=active_membership&.ephemeris ? 'PRINT' : ''%></td>
            <td data-column="interests"><%=person.interests.map{|i| i.name&.titleize}.join(', ')%></td>
            <td data-column="roles"><%=person.roles.map(&:name).join(', ')%></td>
            <td data-column="skills"><%=person.skills.map(&:name).join(', ')%></td>
            <!--<td><%=person.donations.map{|d| dollar_format(d.value)}.join(', ')%></td>-->
          </tr>
        <% end %>
      </tbody>
      </table>
    </div>
  </div>
  <%= pagy_bootstrap_nav(@pagy).html_safe %>
<% end %>