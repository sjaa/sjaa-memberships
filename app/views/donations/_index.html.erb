<% donations ||= @donations %>
<% is_admin = @user.is_a?(Admin) %>
<%= turbo_frame_tag 'donations' do %>
  <div class="row">
    <% if @pagy %>
      <div class="col-12 mb-3">
        <%= pagy_bootstrap_nav(@pagy).html_safe %>
      </div>
    <% end %>
    <% donations.each do |donation| %>
      <div class="col-sm-6 col-lg-4 col-xl-3 mb-3">
        <div class="card h-100 shadow-sm">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-2">
            <div class="card-title mb-0 small fw-bold">
              <% if is_admin %>
                <%= link_to donation.name, donation, class: "text-white text-decoration-none", data: {turbo: false} %>
              <% else %>
                <%= donation.name %>
              <% end %>
            </div>
            <span class="badge bg-light text-primary"><%= dollar_format donation.value %></span>
          </div>
          <div class="card-body p-3">
            <div class="mb-2">
              <small class="text-muted d-block mb-1">Donor</small>
              <% if donation.person %>
                <% if is_admin %>
                  <%= link_to donation.person.name, donation.person, class: "text-decoration-none", data: {turbo: false} %>
                <% else %>
                  <%= donation.person.name %>
                <% end %>
              <% else %>
                <span class="text-muted fst-italic small">No donor specified</span>
              <% end %>
            </div>
            <% if donation.items.any? %>
              <div class="donation-items">
                <small class="text-muted d-block mb-1">Items</small>
                <div class="list-group list-group-flush">
                  <% donation.items.each do |di| %>
                    <div class="list-group-item px-0 py-1">
                      <div class="d-flex justify-content-between align-items-start">
                        <small class="flex-grow-1">
                          <%= di.cash ? 'Cash' : di.equipment&.to_html&.html_safe %>
                        </small>
                        <% if di.value && (di.cash || is_admin) %>
                          <span class="badge bg-success ms-2" style="font-size: 0.7rem;"><%= '$' + sprintf('%.2f', di.value) %></span>
                        <% end %>
                      </div>
                      <% if di.phases.any? %>
                        <div class="mt-1">
                          <small class="text-muted d-block" style="font-size: 0.7rem;">Phases:</small>
                          <ul class="list-unstyled ms-2 mb-0">
                            <% di.phases.each do |phase| %>
                              <li style="font-size: 0.7rem;">
                                <span class="badge bg-secondary" style="font-size: 0.65rem;"><%= phase.name.capitalize %></span>
                                <%= phase.person&.name %>
                                <span class="text-muted"><%= date_format phase.date %></span>
                              </li>
                            <% end %>
                          </ul>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% else %>
              <p class="text-muted fst-italic small mb-0">No items</p>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
    <% if donations.empty? %>
      <div class="col-12">
        <div class="alert alert-info text-center" role="alert">
          <i class="bi bi-info-circle me-2"></i>
          No donations found.
        </div>
      </div>
    <% end %>
    <% if @pagy %>
      <div class="col-12 mt-3">
        <%= pagy_bootstrap_nav(@pagy).html_safe %>
      </div>
    <% end %>
  </div>
<% end %>