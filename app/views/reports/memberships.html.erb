<div class="row">
  <div class="col-12">
    <h1>Membership Report</h1>
    <!-- Form for selecting date range -->
    <form method="get" action="<%= memberships_report_path %>" class="mb-3">
      <div class="input-group">
        <input type="date" name="start" value="<%= @start_date %>" class="form-control" aria-label="Start Date">
        <input type="date" name="end" value="<%= @end_date %>" class="form-control" aria-label="End Date">
        <button type="submit" class="btn btn-primary">Generate Report</button>
      </div>
      <div class="form-check mt-2">
        <input type="checkbox" name="new_members_only" value="1" class="form-check-input" id="newMembersOnly" <%= 'checked' if params[:new_members_only] == '1' %>>
        <label class="form-check-label" for="newMembersOnly">
          Show only brand new members (no previous membership)
        </label>
      </div>
    </form>
    <% new_memberships_count = @report[:new_memberships].count %>
    <% lost_memberships_count = @new_members_only ? '--' : @report[:lost_memberships].count %>
    <% new_memberships = @report[:new_memberships].count %>
    <% returning_members = @new_members_only ? '--' : @report[:previous_memberships].count %>
    <!-- Show total changes in memberships -->
    <%= table class: "table table-bordered mb-3" do %>
    <thead>
      <tr>
        <th>Beginning Total Membership</th>
        <th>Ending Total Membership</th>
        <th>Change</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><%= @new_members_only ? '--' : @report[:starting_count] %></td>
        <td><%= @new_members_only ? '--' : @report[:ending_count] %></td>
        <td><%= @new_members_only ? '--' : (@report[:ending_count] - @report[:starting_count]) %></td>
      </tr>
    </tbody>
    <% end %>
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="mb-0">Memberships Gained <span style="color: green;">(<%=new_memberships_count%>)</span></h2>
      <%= link_to "Download CSV", memberships_report_path(start: @start_date, end: @end_date, new_members_only: params[:new_members_only], csv_type: 'gained', format: :csv), class: "btn btn-sm btn-primary" %>
    </div>
    <!-- Show totals -->
    <%= table class: "table table-bordered mb-3" do %>
      <thead>
        <tr>
          <th>New Memberships</th>
          <th>New Members</th>
          <th>Renewals</th>
          <th>Donation Amount</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><%= new_memberships %></td>
          <td><%= @new_members_only ? new_memberships : (new_memberships - returning_members) %></td>
          <td><%= returning_members %></td>
          <td><%= dollar_format(@report[:total_donations]) %></td>
        </tr>
      </tbody>
    <% end %>
    <!-- Table with columns for name, membership start, membership end, donation -->
    <%= table class: "table table-hover table-striped table-sm" do %>
      <thead>
        <tr>
          <th>Name</th>
          <th>Start</th>
          <th>End</th>
          <th>Donation</th>
          <th>Previous</th>
          <th>First Membership</th>
        </tr>
      </thead>
      <tbody class="table-group-divider">
        <% @report[:new_memberships].each do |person, new_memberships| %>
        <% new_membership = new_memberships.first %>
        <% previous_membership = @report[:previous_memberships][person.id]&.first %>
        <% donation = new_membership.donation_amount || 0 %>
        <% first_membership_date = @report[:first_memberships_gained][person.id] %>
        <tr>
          <td style="white-space: nowrap;"><%= link_to person.name, person %></td>
          <td style="white-space: nowrap;"><%= date_format(new_membership.start)%></td>
          <td style="white-space: nowrap;"><%= date_format(new_membership.end)%></td>
          <td style="white-space: nowrap;"><%= donation > 0 ? dollar_format(donation) : '' %></td>
          <td style="white-space: nowrap;"><%= previous_membership ? date_format(previous_membership.end) : 'New Member' %></td>
          <td style="white-space: nowrap;"><%= date_format(first_membership_date) %></td>
        </tr>
        <% end %>
      </tbody>
    <% end %>
    <% unless @new_members_only %>
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="mb-0">Memberships Lost <span style="color: red;">(<%=lost_memberships_count%>)</span></h2>
        <%= link_to "Download CSV", memberships_report_path(start: @start_date, end: @end_date, csv_type: 'lost', format: :csv), class: "btn btn-sm btn-primary" %>
      </div>
      <%= table class: "table table-hover table-striped table-sm" do %>
        <thead>
          <tr>
            <th>Name</th>
            <th>Membership Start</th>
            <th>Membership End</th>
            <th>First Membership</th>
          </tr>
        </thead>
        <tbody class="table-group-divider">
          <% @report[:lost_memberships].each do |person, lost_memberships| %>
          <% lost_membership = lost_memberships.first %>
          <% first_membership_date = @report[:first_memberships_lost][person.id] %>
          <tr>
            <td><%= link_to person.name, person %></td>
            <td><%= date_format(lost_membership.start) %></td>
            <td><%= date_format(lost_membership.end) %></td>
            <td><%= date_format(first_membership_date) %></td>
          </tr>
          <% end %>
        </tbody>
      <% end %>
    <% end %>
  </div>
</div>