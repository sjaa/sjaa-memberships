<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Volunteer Opportunities</h1>
  <% if policy(Opportunity).new? %>
    <%= link_to 'New Opportunity', new_opportunity_path, class: 'btn btn-success' %>
  <% end %>
</div>

<% if @opportunities_with_match.empty? %>
  <div class="alert alert-info">
    <p class="mb-0">No volunteer opportunities are currently available. Check back soon!</p>
  </div>
<% else %>
  <div class="row">
    <% @opportunities_with_match.each do |opportunity, full_matches, partial_matches| %>
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100 <%= 'border-success' if full_matches > 0 && partial_matches == 0 %> <%= 'border-secondary' unless opportunity.active %>">
          <div class="card-header <%= 'bg-secondary text-white' unless opportunity.active %>">
            <h5 class="mb-0">
              <%= opportunity.title %>
              <% if policy(Opportunity).edit? && !opportunity.active %>
                <span class="badge bg-dark">INACTIVE</span>
              <% end %>
            </h5>
          </div>
          <div class="card-body">
            <% if @user&.is_a?(Person) && (full_matches > 0 || partial_matches > 0) %>
              <div class="mb-3">
                <% if full_matches > 0 %>
                  <div class="text-success mb-1">
                    <i class="bi bi-check-circle-fill"></i>
                    <strong><%= full_matches %></strong> full <%= 'match'.pluralize(full_matches) %>
                  </div>
                <% end %>
                <% if partial_matches > 0 %>
                  <div class="text-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong><%= partial_matches %></strong> partial <%= 'match'.pluralize(partial_matches) %>
                  </div>
                <% end %>
              </div>
            <% end %>
            <% if opportunity.description.present? %>
              <div class="card-text"><%= markdown(truncate(opportunity.description, length: 500)) %></div>
            <% end %>

            <% if opportunity.opportunity_skills.any? %>
              <h6 class="mt-3 mb-2">Required Skills:</h6>
              <div class="d-flex flex-wrap gap-1">
                <% opportunity.opportunity_skills.includes(:skill).each do |os| %>
                  <span class="badge <%= skill_level_bg(os.skill_level_before_type_cast) %>">
                    <%= os.skill.name %> (<%= os.skill_level_name %>)
                  </span>
                <% end %>
              </div>
            <% end %>
          </div>
          <div class="card-footer bg-transparent">
            <%= link_to 'View Details', opportunity, class: 'btn btn-primary btn-sm' %>
            <% if policy(opportunity).edit? %>
              <%= link_to 'Edit', edit_opportunity_path(opportunity), class: 'btn btn-secondary btn-sm' %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% end %>
